const API_URL="localhost"===window.location.hostname?"http://localhost:5000/api":"/api";class Auth{constructor(){this.token=localStorage.getItem("token"),this.user=JSON.parse(localStorage.getItem("user")||"null"),this.init()}init(){this.updateAuthUI(),this.checkTokenExpiry()}isLoggedIn(){return!(!this.token||!this.user)}isAdmin(){return this.isLoggedIn()&&"admin"===this.user.role}async login(e,t){try{const s=await fetch(`${API_URL}/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})}),n=await s.json();return n.success?(this.setAuth(n.token,n.user),{success:!0,user:n.user}):{success:!1,message:n.message||"Login failed"}}catch(e){return console.error("Login error:",e),{success:!1,message:"Connection error"}}}async register(e,t,s){try{const n=await fetch(`${API_URL}/auth/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,email:t,password:s})}),o=await n.json();return o.success?(this.setAuth(o.token,o.user),{success:!0,user:o.user}):{success:!1,message:o.message||"Registration failed"}}catch(e){return console.error("Registration error:",e),{success:!1,message:"Connection error"}}}logout(){localStorage.removeItem("token"),localStorage.removeItem("user"),this.token=null,this.user=null,this.updateAuthUI(),window.location.pathname.includes("index.html")||window.location.pathname.endsWith("/")||(window.location.href="index.html")}setAuth(e,t){this.token=e,this.user=t,localStorage.setItem("token",e),localStorage.setItem("user",JSON.stringify(t)),this.updateAuthUI()}updateAuthUI(){const e=document.getElementById("auth-links"),t=document.getElementById("user-info"),s=document.getElementById("user-email"),n=document.getElementById("user-avatar");e&&t&&(this.isLoggedIn()?(e.style.display="none",t.style.display="flex",s&&(s.textContent=this.user.email),n&&(n.textContent=this.user.username.charAt(0).toUpperCase()),this.updateAdminLinks()):(e.style.display="flex",t.style.display="none"))}updateAdminLinks(){const e=document.querySelectorAll(".admin-link"),t=document.querySelectorAll(".admin-only");this.isAdmin()?(e.forEach(e=>e.style.display="block"),t.forEach(e=>e.style.display="block")):(e.forEach(e=>e.style.display="none"),t.forEach(e=>e.style.display="none"))}async checkTokenExpiry(){if(this.token)try{(await fetch(`${API_URL}/auth/me`,{headers:{"x-auth-token":this.token}})).ok||this.logout()}catch(e){console.error("Token check error:",e)}}getAuthHeaders(){return{"Content-Type":"application/json","x-auth-token":this.token}}async refreshToken(){if(!this.token)return null;try{const e=await fetch(`${API_URL}/auth/refresh`,{method:"POST",headers:this.getAuthHeaders()}),t=await e.json();if(t.success)return this.setAuth(t.token,t.user),t.token}catch(e){console.error("Token refresh error:",e)}return null}requireAuth(e="user-login.html"){return!!this.isLoggedIn()||(window.location.href=e,!1)}requireAdmin(e="index.html"){return!!this.isAdmin()||(window.location.href=e,!1)}}const auth=new Auth;window.auth=auth,"undefined"!=typeof module&&module.exports&&(module.exports=auth),document.addEventListener("DOMContentLoaded",()=>{auth.updateAuthUI()});