const API_URL="localhost"===window.location.hostname?"http://localhost:5000/api":"/api";let authToken=localStorage.getItem("token")||localStorage.getItem("authToken"),currentEditPostId=null;function checkAuth(){authToken?(showDashboard(),loadPosts(),loadStats()):showLogin()}function setupEventListeners(){document.getElementById("show-register")?.addEventListener("click",e=>{e.preventDefault(),document.getElementById("login-section").style.display="none",document.getElementById("register-section").style.display="block"}),document.getElementById("show-login")?.addEventListener("click",e=>{e.preventDefault(),document.getElementById("register-section").style.display="none",document.getElementById("login-section").style.display="block"}),document.getElementById("login-form")?.addEventListener("submit",handleLogin),document.getElementById("register-form")?.addEventListener("submit",handleRegister),document.getElementById("create-post-form")?.addEventListener("submit",handleCreatePost),document.getElementById("edit-post-form")?.addEventListener("submit",handleUpdatePost),document.getElementById("logout-btn")?.addEventListener("click",handleLogout),document.querySelectorAll(".tab-btn").forEach(e=>{e.addEventListener("click",()=>{switchTab(e.dataset.tab)})}),document.getElementById("filter-status")?.addEventListener("change",loadPosts),document.getElementById("filter-category")?.addEventListener("change",loadPosts),document.getElementById("post-meta")?.addEventListener("input",e=>{document.getElementById("meta-count").textContent=e.target.value.length}),document.querySelector(".close")?.addEventListener("click",closeModal),window.addEventListener("click",e=>{e.target.classList.contains("modal")&&closeModal()})}function showLogin(){document.getElementById("login-section").style.display="block",document.getElementById("register-section").style.display="none",document.getElementById("dashboard-section").style.display="none"}function showDashboard(){document.getElementById("login-section").style.display="none",document.getElementById("register-section").style.display="none",document.getElementById("dashboard-section").style.display="block"}async function handleLogin(e){e.preventDefault();const t=document.getElementById("login-email").value,n=document.getElementById("login-password").value,o=document.getElementById("login-message");try{const e=await fetch(`${API_URL}/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,password:n})}),s=await e.json();e.ok?(authToken=s.token,localStorage.setItem("authToken",s.token),o.className="message success",o.textContent="Login successful!",setTimeout(()=>{showDashboard(),loadPosts(),loadStats()},1e3)):(o.className="message error",o.textContent=s.message||"Login failed")}catch(e){o.className="message error",o.textContent="Login failed. Please try again."}}async function handleRegister(e){e.preventDefault();const t=document.getElementById("register-username").value,n=document.getElementById("register-email").value,o=document.getElementById("register-password").value,s=document.getElementById("register-message");try{const e=await fetch(`${API_URL}/auth/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,email:n,password:o})}),a=await e.json();e.ok?(authToken=a.token,localStorage.setItem("authToken",a.token),s.className="message success",s.textContent="Account created successfully!",setTimeout(()=>{showDashboard(),loadPosts(),loadStats()},1e3)):(s.className="message error",s.textContent=a.message||"Registration failed")}catch(e){s.className="message error",s.textContent="Registration failed. Please try again."}}function handleLogout(){authToken=null,localStorage.removeItem("authToken"),showLogin()}function switchTab(e){document.querySelectorAll(".tab-btn").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".tab-content").forEach(e=>e.classList.remove("active")),document.querySelector(`[data-tab="${e}"]`).classList.add("active"),document.getElementById(`${e}-tab`).classList.add("active"),"posts"===e?loadPosts():"stats"===e&&loadStats()}async function loadPosts(){const e=document.getElementById("admin-posts-list");e.innerHTML='<div class="loading">Loading posts...</div>';const t=document.getElementById("filter-status")?.value||"",n=document.getElementById("filter-category")?.value||"";try{let o=`${API_URL}/posts?limit=100`;t&&(o+=`&status=${t}`),n&&(o+=`&category=${n}`);const s=await fetch(o,{headers:{Authorization:`Bearer ${authToken}`}}),a=await s.json();if(0===a.posts.length)return void(e.innerHTML='<p class="error">No posts found.</p>');displayAdminPosts(a.posts)}catch(t){console.error("Error loading posts:",t),e.innerHTML='<p class="error">Failed to load posts.</p>'}}function displayAdminPosts(e){const t=document.getElementById("admin-posts-list"),n=e.map(e=>`\n        <div class="admin-post-card">\n            <div class="post-info">\n                <h3>${e.title}</h3>\n                <div class="post-stats">\n                    <span>üìÅ ${e.category}</span>\n                    <span>üìä ${e.status}</span>\n                    <span>üëÅÔ∏è ${e.views} views</span>\n                    <span>üìÖ ${new Date(e.createdAt).toLocaleDateString()}</span>\n                </div>\n            </div>\n            <div class="post-actions">\n                <button class="btn btn-edit" onclick="editPost('${e._id}')">Edit</button>\n                <button class="btn btn-delete" onclick="deletePost('${e._id}')">Delete</button>\n            </div>\n        </div>\n    `).join("");t.innerHTML=n}async function handleCreatePost(e){e.preventDefault();const t=document.getElementById("create-message"),n=document.getElementById("publish-btn"),o=n?n.textContent:null;try{n&&(n.disabled=!0,n.textContent="Publishing...");const e={title:document.getElementById("post-title").value,category:document.getElementById("post-category").value,excerpt:document.getElementById("post-excerpt").value,content:"",metaDescription:document.getElementById("post-meta")?document.getElementById("post-meta").value:"",keywords:document.getElementById("post-keywords")?document.getElementById("post-keywords").value.split(",").map(e=>e.trim()).filter(e=>e):[],status:document.getElementById("post-status")?document.getElementById("post-status").value:"published"};try{window.tinymce&&tinymce.get("post-content")?e.content=tinymce.get("post-content").getContent():e.content=document.getElementById("post-content").value}catch(t){console.error("Error reading editor content:",t),e.content=document.getElementById("post-content").value||""}const s=document.createElement("div");s.innerHTML=e.content||"";const a=(s.textContent||s.innerText||"").trim().split(/\s+/).filter(Boolean).length;if(a<1e3)return t.className="message error",t.textContent=`Content must be at least 1000 words (currently ${a}).`,void(n&&(n.disabled=!1,n.textContent=o));if(!authToken)return t.className="message error",t.textContent="Not authenticated. Please log in.",n&&(n.disabled=!1,n.textContent=o),void setTimeout(()=>window.location.href="login.html",800);const d=await fetch(`${API_URL}/posts`,{method:"POST",headers:{"Content-Type":"application/json","x-auth-token":authToken},body:JSON.stringify(e)}),l=await d.json();d.ok&&l.success?(t.className="message success",t.textContent="Post created successfully!",document.getElementById("create-post-form").reset(),document.getElementById("meta-count")&&(document.getElementById("meta-count").textContent="0"),"function"==typeof hidePostForm?setTimeout(()=>{hidePostForm(),loadPosts()},1200):(loadStats(),"function"==typeof switchTab&&setTimeout(()=>{switchTab("posts")},1200))):(t.className="message error",t.textContent=l.message||"Failed to create post",console.error("Create post failed:",l))}catch(e){console.error("Failed to create post:",e),t.className="message error",t.textContent="Failed to create post. Please try again."}finally{n&&(n.disabled=!1,n.textContent=o||"Publish Post")}}async function editPost(e){try{const t=await fetch(`${API_URL}/posts`,{headers:{Authorization:`Bearer ${authToken}`}}),n=(await t.json()).posts.find(t=>t._id===e);if(!n)return;currentEditPostId=e,document.getElementById("edit-post-id").value=n._id,document.getElementById("edit-title").value=n.title,document.getElementById("edit-category").value=n.category,document.getElementById("edit-excerpt").value=n.excerpt,document.getElementById("edit-content").value=n.content,document.getElementById("edit-meta").value=n.metaDescription,document.getElementById("edit-keywords").value=n.keywords.join(", "),document.getElementById("edit-status").value=n.status,document.getElementById("edit-modal").style.display="block"}catch(e){alert("Failed to load post details")}}async function handleUpdatePost(e){e.preventDefault();const t=document.getElementById("edit-message"),n={title:document.getElementById("edit-title").value,category:document.getElementById("edit-category").value,excerpt:document.getElementById("edit-excerpt").value,content:document.getElementById("edit-content").value,metaDescription:document.getElementById("edit-meta").value,keywords:document.getElementById("edit-keywords").value.split(",").map(e=>e.trim()).filter(e=>e),status:document.getElementById("edit-status").value};try{const e=await fetch(`${API_URL}/posts/${currentEditPostId}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${authToken}`},body:JSON.stringify(n)}),o=await e.json();e.ok?(t.className="message success",t.textContent="Post updated successfully!",loadPosts(),loadStats(),setTimeout(()=>{closeModal()},1500)):(t.className="message error",t.textContent=o.message||"Failed to update post")}catch(e){t.className="message error",t.textContent="Failed to update post. Please try again."}}async function deletePost(e){if(confirm("Are you sure you want to delete this post?"))try{(await fetch(`${API_URL}/posts/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${authToken}`}})).ok?(alert("Post deleted successfully!"),loadPosts(),loadStats()):alert("Failed to delete post")}catch(e){alert("Failed to delete post. Please try again.")}}async function loadStats(){try{const e=await fetch(`${API_URL}/posts?limit=1000`,{headers:{Authorization:`Bearer ${authToken}`}}),t=await e.json(),n=t.posts.length,o=t.posts.filter(e=>"published"===e.status).length,s=t.posts.filter(e=>"draft"===e.status).length,a=t.posts.reduce((e,t)=>e+t.views,0);document.getElementById("total-posts").textContent=n,document.getElementById("published-posts").textContent=o,document.getElementById("draft-posts").textContent=s,document.getElementById("total-views").textContent=a}catch(e){console.error("Error loading stats:",e)}}function closeModal(){document.getElementById("edit-modal").style.display="none",document.getElementById("edit-message").textContent="",document.getElementById("edit-message").className="message"}document.addEventListener("DOMContentLoaded",()=>{checkAuth(),setupEventListeners()});