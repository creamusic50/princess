<!DOCTYPE html>
<html lang="en">
<head>
 <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4861288278202695"
     crossorigin="anonymous"></script>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <meta name="google-site-verification" content="p7ObZPC6DOBVi-AUb8yGPQMlDFuLkMFZvLPv0vvfS8w" />
 <meta name="google-adsense-account" content="ca-pub-4861288278202695">
 <meta name="robots" content="noindex, nofollow">
 <title>Admin Dashboard - Smart Money Guide</title>
 <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=">
 <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
        
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .admin-header .container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .admin-header h1 { font-size: 26px; font-weight: 600; }
        .admin-header .user-info {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .logout-btn, .settings-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 10px 18px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
        }
        .logout-btn:hover, .settings-btn:hover { 
            background: rgba(255,255,255,0.3); 
            transform: translateY(-2px);
        }
        
        .admin-container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            color: white;
        }
        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 12px;
            font-weight: 500;
        }
        .stat-card .number {
            font-size: 38px;
            font-weight: 700;
        }
        
        .actions-panel {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .actions-panel h2 {
            margin-bottom: 20px;
            color: #2d3748;
            font-weight: 600;
        }
        .btn {
            display: inline-block;
            padding: 12px 24px;
            margin-right: 10px;
            margin-bottom: 10px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
        }
        .btn:hover { 
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .btn-success { background: #48bb78; }
        .btn-success:hover { background: #38a169; }
        .btn-danger { background: #f56565; }
        .btn-danger:hover { background: #e53e3e; }
        
        .form-container {
            background: white;
            padding: 35px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: none;
        }
        .form-container.active { display: block; }
        .form-group {
            margin-bottom: 25px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2d3748;
            font-weight: 600;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-group textarea {
            min-height: 150px;
            font-family: 'Courier New', monospace;
        }
        
        .posts-list {
            background: white;
            padding: 35px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .posts-list h2 {
            margin-bottom: 25px;
            color: #2d3748;
            font-weight: 600;
        }
        .post-item {
            padding: 20px;
            border-bottom: 2px solid #f7fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }
        .post-item:hover { background: #f7fafc; }
        .post-item:last-child { border-bottom: none; }
        .post-info h3 {
            margin-bottom: 8px;
            color: #2d3748;
            font-weight: 600;
        }
        .post-info p {
            color: #718096;
            font-size: 14px;
        }
        .post-actions button {
            margin-left: 10px;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        .btn-edit { 
            background: #ed8936; 
            color: white; 
        }
        .btn-edit:hover { 
            background: #dd6b20;
            transform: translateY(-2px);
        }
        .btn-delete { 
            background: #f56565; 
            color: white; 
        }
        .btn-delete:hover { 
            background: #e53e3e;
            transform: translateY(-2px);
        }
        
        .message {
            padding: 18px;
            border-radius: 8px;
            margin-bottom: 25px;
            display: none;
            font-weight: 500;
        }
        .message.success {
            background: #c6f6d5;
            color: #22543d;
            border-left: 4px solid #48bb78;
        }
        .message.error {
            background: #fed7d7;
            color: #742a2a;
            border-left: 4px solid #f56565;
        }
        .message.show { display: block; }
        
        /* Settings Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
        }
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 35px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .close {
            color: #a0aec0;
            float: right;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        .close:hover { color: #2d3748; }
        
        .editor-container {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            min-height: 500px;
            background: white;
        }
        
        @media (max-width: 768px) {
            .admin-header .container {
                flex-direction: column;
                text-align: center;
            }
            .post-item {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            .post-actions {
                width: 100%;
                display: flex;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
 <div class="admin-header">
 <div class="container">
 <h1>Ô∏è Admin Dashboard</h1>
 <div class="user-info">
 <span id="user-email" style="font-weight: 500;">Loading...</span>
 <div id="debug-auth" style="margin-left:10px; font-size:12px; opacity:0.9;
 background: rgba(255,255,255,0.08); padding:6px 10px; border-radius:6px;">
 <div id="debug-token">Token: checking...</div>
 <div id="debug-status">Auth: pending...</div>
 </div>
 <button id="btn-settings" class="settings-btn">Ô∏è Settings</button>
 <button id="btn-logout" class="logout-btn"> Logout</button>
 </div>
 </div>
 </div>

 <div class="admin-container">
 <div id="message" class="message"></div>
 
 <div class="stats-grid">
 <div class="stat-card">
 <h3>Total Posts</h3>
 <div class="number" id="total-posts">0</div>
 </div>
 <div class="stat-card">
 <h3>Published Posts</h3>
 <div class="number" id="published-posts">0</div>
 </div>
 <div class="stat-card">
 <h3>Total Views</h3>
 <div class="number" id="total-views">0</div>
 </div>
 <div class="stat-card">
 <h3>Categories</h3>
 <div class="number" id="total-categories">6</div>
 </div>
 </div>

 <div class="actions-panel">
 <h2> Quick Actions</h2>
 <button id="btn-new-post" class="btn btn-success"> New Post</button>
 <button id="btn-refresh-posts" class="btn"> Refresh Posts</button>
 <a href="index.html" class="btn" target="_blank">Ô∏è View Website</a>
 </div>

 <div id="post-form" class="form-container">
 <h2 id="form-title" style="margin-bottom: 25px; color: #2d3748; font-weight: 600;">Create New Post</h2>
 <form id="create-post-form">
 <input type="hidden" id="post-id">
 
 <div class="form-group">
 <label for="post-title"> Title *</label>
 <input type="text" id="post-title" required placeholder="Enter post title">
 </div>
 
 <div class="form-group">
 <label for="post-category"> Category *</label>
 <select id="post-category" required>
 <option value="">Select Category</option>
 <option value="Saving Tips"> Saving Tips</option>
 <option value="Investing"> Investing</option>
 <option value="Budgeting"> Budgeting</option>
 <option value="Retirement">Ô∏è Retirement</option>
 <option value="Credit Cards"> Credit Cards</option>
 <option value="Money Management"> Money Management</option>
 </select>
 </div>
 
 <div class="form-group">
 <label for="post-excerpt"> Excerpt (Short Description) *</label>
 <textarea id="post-excerpt" rows="3" required placeholder="Brief summary of the post"></textarea>
 </div>
 
 <div class="form-group">
 <label for="post-content"> Content (HTML) - Min 1000 words *</label>
 <textarea id="post-content" rows="20" placeholder="Write your post content here (HTML allowed)"></textarea>
 <small style="color: #718096; margin-top: 8px; display: block;">
 Use HTML tags: &lt;h2&gt;, &lt;p&gt;, &lt;ul&gt;, &lt;li&gt;, &lt;strong&gt;, &lt;em&gt;
 </small>
 </div>
 
 <div class="form-group">
 <label for="post-image"> Feature Image (optional)</label>
 <input type="file" id="post-image" accept="image/*">
 <div id="post-image-preview" style="margin-top:10px; display:none;">
     <img id="post-image-thumb" src="" alt="preview" style="max-width:240px; border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,0.08);" />
 </div>
 <small style="color:#718096; display:block; margin-top:8px;">Images will be uploaded to Cloudinary CDN. Configure Cloudinary in Settings.</small>
 </div>

 <button id="publish-btn" type="submit" class="btn btn-success"> Publish Post</button>
 <button id="btn-cancel-post" type="button" class="btn" style="background: #a0aec0;"> Cancel</button>
 </form>
 </div>

 <div class="posts-list">
 <h2> All Posts</h2>
 <div id="posts-container">
 <p style="text-align: center; padding: 20px; color: #718096;">Loading posts...</p>
 </div>
 </div>
 </div>

 <!-- Settings Modal -->
 <div id="settings-modal" class="modal">
 <div class="modal-content">
 <span id="settings-close" class="close">&times;</span>
 <h2 style="margin-bottom: 25px; color: #2d3748; font-weight: 600;">Ô∏è Account Settings</h2>
 
 <div id="settings-message" class="message"></div>
 
 <form id="settings-form">
 <div class="form-group">
 <label for="settings-email"> Email</label>
 <input type="email" id="settings-email" placeholder="your@email.com">
 </div>
 
 <div class="form-group">
 <label for="cloud-name">Cloudinary Cloud Name</label>
 <input type="text" id="cloud-name" placeholder="your-cloud-name (e.g. demo)">
 </div>

 <div class="form-group">
 <label for="cloud-upload-preset">Cloudinary Upload Preset (unsigned)</label>
 <input type="text" id="cloud-upload-preset" placeholder="upload_preset">
 <small style="color:#718096; display:block; margin-top:6px;">Create an unsigned upload preset in your Cloudinary dashboard and paste it here.</small>
 </div>
 
 <div class="form-group">
 <label for="current-password"> Current Password (required to change)</label>
 <input type="password" id="current-password" placeholder="Enter current password">
 </div>
 
 <div class="form-group">
 <label for="new-password"> New Password</label>
 <input type="password" id="new-password" placeholder="Enter new password (min 6 chars)">
 </div>
 
 <div class="form-group">
 <label for="confirm-password"> Confirm New Password</label>
 <input type="password" id="confirm-password" placeholder="Confirm new password">
 </div>
 
 <button type="submit" class="btn btn-success"> Save Changes</button>
 <button type="button" id="btn-settings-cancel" class="btn" style="background: #a0aec0;">Cancel</button>
 </form>
 </div>
 </div>

 <script>
        const API_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:5000/api' 
            : '/api';
        
        // Read token from both current and legacy keys
        let token = localStorage.getItem('token') || localStorage.getItem('authToken');
        let currentUser = null;

        // Check authentication
        async function checkAuth() {
            // Update debug UI
            const dbgTokenEl = document.getElementById('debug-token');
            const dbgStatusEl = document.getElementById('debug-status');
            if (dbgTokenEl) dbgTokenEl.textContent = token ? 'Token: present' : 'Token: absent';

            if (!token) {
                if (dbgStatusEl) dbgStatusEl.textContent = 'Auth: no token';
                window.location.href = 'login.html';
                return;
            }

            try {
                if (dbgStatusEl) dbgStatusEl.textContent = 'Auth: checking...';
                const response = await fetch(`${API_URL}/auth/me`, {
                    headers: { 'x-auth-token': token }
                });

                if (!response.ok) {
                    if (dbgStatusEl) dbgStatusEl.textContent = `Auth: failed (${response.status})`;
                    throw new Error('Authentication failed');
                }

                const data = await response.json();
                if (data.success && data.user.role === 'admin') {
                    if (dbgStatusEl) dbgStatusEl.textContent = 'Auth: OK (admin)';
                    currentUser = data.user;
                    document.getElementById('user-email').textContent = data.user.email;
                    // Refresh module-level token variable (in case login happened elsewhere)
                    token = localStorage.getItem('token') || localStorage.getItem('authToken');
                    if (dbgTokenEl) dbgTokenEl.textContent = token ? 'Token: present' : 'Token: absent';
                    loadPosts();
                } else {
                    if (dbgStatusEl) dbgStatusEl.textContent = 'Auth: not authorized';
                    throw new Error('Not authorized');
                }
            } catch (error) {
                console.error('Auth error:', error);
                localStorage.removeItem('token');
                localStorage.removeItem('authToken');
                if (dbgStatusEl) dbgStatusEl.textContent = 'Auth: error';
                window.location.href = 'login.html';
            }
        }

        // Load all posts
        async function loadPosts() {
            const container = document.getElementById('posts-container');
            container.innerHTML = '<p style="text-align: center; padding: 20px;">Loading...</p>';

            try {
                const response = await fetch(`${API_URL}/posts?page=1&limit=100`);
                const data = await response.json();

                if (data.success && data.posts.length > 0) {
                    document.getElementById('total-posts').textContent = data.total || data.posts.length;
                    document.getElementById('published-posts').textContent = data.posts.filter(p => p.published).length;
                    
                    const totalViews = data.posts.reduce((sum, post) => sum + (post.views || 0), 0);
                    document.getElementById('total-views').textContent = totalViews;

                    const html = data.posts.map(post => `
                        <div class="post-item" data-id="${post.id}">
                            <div class="post-info">
                                <h3>${escapeHtml(post.title)}</h3>
                                <p>
                                    ${post.category} | 
                                    ${post.views || 0} views | 
                                    ${post.published ? '‚úÖ Published' : 'üìù Draft'} |
                                    ${new Date(post.created_at).toLocaleDateString()}
                                </p>
                            </div>
                            <div class="post-actions">
                                <button class="btn-edit" data-id="${post.id}">‚úèÔ∏è Edit</button>
                                <button class="btn-delete" data-id="${post.id}" data-title="${escapeHtml(post.title).replace(/'/g, "\\'")}">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                    `).join('');

                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p style="text-align: center; padding: 20px; color: #718096;">No posts yet. Create your first post!</p>';
                }
            } catch (error) {
                console.error('Error loading posts:', error);
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: #f56565;">Error loading posts.</p>';
            }
        }

        // Show new post form
        function showNewPostForm() {
            document.getElementById('form-title').textContent = 'Create New Post';
            document.getElementById('create-post-form').reset();
            document.getElementById('post-id').value = '';
            
            // Clear editor textarea
            const editorEl = document.getElementById('post-content');
            if (editorEl) editorEl.value = '';
            
            document.getElementById('post-form').classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Hide post form
        function hidePostForm() {
            document.getElementById('post-form').classList.remove('active');
        }

        // Create/Update post form submit
        function registerFormHandler() {
            const formEl = document.getElementById('create-post-form');
            if (!formEl) return console.warn('Create post form not found');

            // Avoid adding multiple listeners if called more than once
            if (formEl.__hasRegister) return;
            formEl.__hasRegister = true;

            formEl.addEventListener('submit', async (e) => {
                console.log('[ADMIN] === PUBLISH HANDLER FIRED ===');
                e.preventDefault();
                const publishBtn = document.getElementById('publish-btn');
                const originalText = publishBtn ? publishBtn.textContent : 'Publish';
                console.log('[ADMIN] Button state:', { disabled: publishBtn?.disabled, text: publishBtn?.textContent });

                try {
                    if (publishBtn) {
                        publishBtn.disabled = true;
                        publishBtn.textContent = '‚è≥ Publishing...';
                    }
                    console.log('[ADMIN] Button disabled, loading form data...');

                    const postId = document.getElementById('post-id').value;
                    const title = document.getElementById('post-title').value;
                    const category = document.getElementById('post-category').value;
                    const excerpt = document.getElementById('post-excerpt').value;
                    const content = document.getElementById('post-content').value;

                    console.log('[ADMIN] Form data collected:', { postId, titleLen: title.length, categoryLen: category.length, excerptLen: excerpt.length, contentLen: content.length });

                    // Fast word count: strip HTML tags and split on whitespace
                    const plainText = content.replace(/<[^>]*>/g, '').trim();
                    const wordCount = plainText ? plainText.split(/\s+/).length : 0;

                    console.log('[ADMIN] Word count:', wordCount);

                    if (wordCount < 1000) {
                        console.warn('[ADMIN] Word count too low, rejecting');
                        showMessage(`‚ùå Content must be at least 1000 words (currently ${wordCount}).`, 'error');
                        if (publishBtn) {
                            publishBtn.disabled = false;
                            publishBtn.textContent = originalText;
                        }
                        return;
                    }

                    const method = postId ? 'PUT' : 'POST';
                    const url = postId ? `${API_URL}/posts/${postId}` : `${API_URL}/posts`;

                    console.log('[ADMIN] API call:', { method, url });

                    // Read token at submit time (ensure latest value)
                    const tokenLocal = localStorage.getItem('token');
                    console.log('[ADMIN] Token present:', !!tokenLocal);
                    if (!tokenLocal) {
                        console.error('[ADMIN] No token in localStorage');
                        showMessage('‚ùå You are not authenticated. Please login again.', 'error');
                        setTimeout(() => { window.location.href = 'login.html'; }, 800);
                        return;
                    }

                    // If an image file is attached, upload it to Cloudinary first
                    let imageUrl = null;
                    try {
                        const imgInput = document.getElementById('post-image');
                        const file = imgInput && imgInput.files && imgInput.files[0];
                        if (file) {
                            console.log('[ADMIN] Uploading image to Cloudinary...');
                            imageUrl = await uploadImageToCloudinary(file);
                            console.log('[ADMIN] Image uploaded:', imageUrl);
                        }
                    } catch (uErr) {
                        console.error('[ADMIN] Image upload failed:', uErr);
                        showMessage('‚ùå Image upload failed: ' + (uErr.message || ''), 'error');
                        if (publishBtn) {
                            publishBtn.disabled = false;
                            publishBtn.textContent = originalText;
                        }
                        return;
                    }

                    console.log('[ADMIN] Sending fetch request...');
                    const response = await fetch(url, {
                        method,
                        headers: {
                            'Content-Type': 'application/json',
                            'x-auth-token': tokenLocal
                        },
                        body: JSON.stringify({ 
                            title, 
                            category, 
                            excerpt, 
                            content, 
                            published: true,
                            image_url: imageUrl
                        })
                    });

                    console.log('[ADMIN] Response received:', { status: response.status, ok: response.ok });

                    const data = await response.json();
                    console.log('[ADMIN] Response data:', data);

                    if (response.ok && data.success) {
                        console.log('[ADMIN] Success! Post saved.');
                        showMessage(postId ? '‚úÖ Post updated!' : '‚úÖ Post created!', 'success');
                        formEl.reset();
                        document.getElementById('post-content').value = '';
                        hidePostForm();
                        loadPosts();
                    } else {
                        console.error('[ADMIN] Server rejected:', data);
                        showMessage((data && data.message) || '‚ùå Failed to save post', 'error');
                    }
                } catch (error) {
                    console.error('[ADMIN] Exception during submit:', error);
                    showMessage('‚ùå Connection error. Please try again.', 'error');
                } finally {
                    const publishBtnFinal = document.getElementById('publish-btn');
                    if (publishBtnFinal) {
                        publishBtnFinal.disabled = false;
                        publishBtnFinal.textContent = originalText;
                    }
                    console.log('[ADMIN] === PUBLISH HANDLER COMPLETE ===');
                }
            });

            // Initialize cloudinary settings in modal
            (function populateCloudinarySettings() {
                const cloudName = localStorage.getItem('cloudinary.cloudName') || '';
                const uploadPreset = localStorage.getItem('cloudinary.uploadPreset') || '';
                const cloudEl = document.getElementById('cloud-name');
                const presetEl = document.getElementById('cloud-upload-preset');
                if (cloudEl) cloudEl.value = cloudName;
                if (presetEl) presetEl.value = uploadPreset;
            })();

            // Cloudinary upload helper
            async function uploadImageToCloudinary(file) {
                // Try Cloudinary signed upload on server first
                const tokenLocal = localStorage.getItem('token') || localStorage.getItem('authToken');

                // Helper to upload to local server storage (/api/upload/image)
                async function uploadToLocal(file) {
                    const fdLocal = new FormData();
                    // server expects field name 'image' for disk storage middleware
                    fdLocal.append('image', file);
                    const respLocal = await fetch(`${API_URL}/upload/image`, {
                        method: 'POST',
                        headers: tokenLocal ? { 'x-auth-token': tokenLocal } : {},
                        body: fdLocal
                    });

                    if (!respLocal.ok) {
                        const txt = await respLocal.text();
                        throw new Error('Local upload failed: ' + txt);
                    }

                    const d = await respLocal.json();
                    if (!d.success) throw new Error(d.message || 'Local upload returned error');
                    // returned url may be relative (/uploads/...), make absolute
                    const url = d.file && d.file.url ? d.file.url : (d.url || d.secure_url);
                    if (!url) throw new Error('Local upload did not return a file URL');
                    return url.startsWith('http') ? url : (window.location.origin.replace(/:\d+$/, ':5000') + url);
                }

                try {
                    const fd = new FormData();
                    fd.append('file', file);

                    const resp = await fetch(`${API_URL}/upload/cloudinary`, {
                        method: 'POST',
                        headers: tokenLocal ? { 'x-auth-token': tokenLocal } : {},
                        body: fd
                    });

                    // If cloudinary route not configured on server, fallback to local upload
                    if (!resp.ok) {
                        let txt;
                        try { txt = await resp.text(); } catch (e) { txt = ''; }
                        const lowered = (txt || '').toLowerCase();
                        if (resp.status === 500 && lowered.includes('cloudinary not configured')) {
                            console.warn('Cloudinary not configured on server, falling back to local upload');
                            return await uploadToLocal(file);
                        }
                        throw new Error('Server upload failed: ' + txt);
                    }

                    const data = await resp.json();
                    if (!data.success) throw new Error(data.message || 'Unknown upload error');
                    return data.url || data.secure_url || (data.raw && data.raw.secure_url) || null;
                } catch (err) {
                    // If cloudinary failed for any reason, attempt local upload as a final fallback
                    console.warn('Primary upload failed, attempting local upload:', err.message || err);
                    return await uploadToLocal(file);
                }
            }

            // Image input preview handling
            const postImageInput = document.getElementById('post-image');
            if (postImageInput) {
                postImageInput.addEventListener('change', (e) => {
                    const f = e.target.files && e.target.files[0];
                    const previewWrap = document.getElementById('post-image-preview');
                    const thumb = document.getElementById('post-image-thumb');
                    if (f && thumb) {
                        const reader = new FileReader();
                        reader.onload = function(ev) {
                            thumb.src = ev.target.result;
                            if (previewWrap) previewWrap.style.display = 'block';
                        };
                        reader.readAsDataURL(f);
                    } else if (previewWrap) {
                        previewWrap.style.display = 'none';
                    }
                });
            }
        }

        // Edit post
        async function editPost(id) {
            try {
                const response = await fetch(`${API_URL}/posts?page=1&limit=100`);
                const data = await response.json();
                
                const post = data.posts.find(p => p.id === id);
                if (post) {
                    document.getElementById('form-title').textContent = 'Edit Post';
                    document.getElementById('post-id').value = post.id;
                    document.getElementById('post-title').value = post.title;
                    document.getElementById('post-category').value = post.category;
                    document.getElementById('post-excerpt').value = post.excerpt;
                    
                    // Set textarea content
                    const ed = document.getElementById('post-content'); if (ed) ed.value = post.content || ''; 
                    // Set existing image preview if available
                    try {
                        const thumb = document.getElementById('post-image-thumb');
                        const previewWrap = document.getElementById('post-image-preview');
                        if (post.image_url && thumb) {
                            thumb.src = post.image_url;
                            if (previewWrap) previewWrap.style.display = 'block';
                        } else if (previewWrap) {
                            previewWrap.style.display = 'none';
                        }
                    } catch (e) {
                        // ignore
                    }
                    
                    document.getElementById('post-form').classList.add('active');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } catch (error) {
                console.error('Error loading post:', error);
                showMessage('‚ùå Error loading post', 'error');
            }
        }

        // Delete post
        async function deletePost(id, title) {
            if (!confirm(`Are you sure you want to delete "${title}"?`)) return;

            try {
                const tokenLocal = localStorage.getItem('token') || localStorage.getItem('authToken');
                const response = await fetch(`${API_URL}/posts/${id}`, {
                    method: 'DELETE',
                    headers: { 'x-auth-token': tokenLocal }
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('‚úÖ Post deleted successfully!', 'success');
                    loadPosts();
                } else {
                    showMessage(data.message || '‚ùå Error deleting post', 'error');
                }
            } catch (error) {
                console.error('Error deleting post:', error);
                showMessage('‚ùå Connection error. Please try again.', 'error');
            }
        }

        // Settings
        function openSettings() {
            if (currentUser) {
                document.getElementById('settings-email').value = currentUser.email;
            }
            document.getElementById('settings-modal').style.display = 'block';
        }

        function closeSettings() {
            document.getElementById('settings-modal').style.display = 'none';
            document.getElementById('settings-form').reset();
            const msg = document.getElementById('settings-message');
            msg.className = 'message';
            msg.style.display = 'none';
        }

        // Settings form submit
        document.getElementById('settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('settings-email').value;
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const messageDiv = document.getElementById('settings-message');

            // Validation
            if (newPassword && newPassword !== confirmPassword) {
                messageDiv.textContent = '‚ùå New passwords do not match';
                messageDiv.className = 'message error show';
                return;
            }

            if (newPassword && newPassword.length < 6) {
                messageDiv.textContent = '‚ùå Password must be at least 6 characters';
                messageDiv.className = 'message error show';
                return;
            }

            if (newPassword && !currentPassword) {
                messageDiv.textContent = '‚ùå Current password is required to change password';
                messageDiv.className = 'message error show';
                return;
            }

            try {
                const updates = { email };
                if (newPassword) {
                    updates.password = newPassword;
                    updates.currentPassword = currentPassword;
                }

                const tokenLocal = localStorage.getItem('token') || localStorage.getItem('authToken');
                const response = await fetch(`${API_URL}/auth/update-profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-auth-token': tokenLocal
                    },
                    body: JSON.stringify(updates)
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    currentUser = data.user;
                    document.getElementById('user-email').textContent = data.user.email;
                    messageDiv.textContent = '‚úÖ Settings updated successfully!';
                    messageDiv.className = 'message success show';
                    // Save Cloudinary config to localStorage as well
                    const cloudName = document.getElementById('cloud-name') ? document.getElementById('cloud-name').value : '';
                    const uploadPreset = document.getElementById('cloud-upload-preset') ? document.getElementById('cloud-upload-preset').value : '';
                    if (cloudName) localStorage.setItem('cloudinary.cloudName', cloudName);
                    if (uploadPreset) localStorage.setItem('cloudinary.uploadPreset', uploadPreset);

                    setTimeout(() => {
                        closeSettings();
                    }, 2000);
                } else {
                    messageDiv.textContent = data.message || '‚ùå Failed to update settings';
                    messageDiv.className = 'message error show';
                }
            } catch (error) {
                console.error('Error updating settings:', error);
                messageDiv.textContent = '‚ùå Connection error. Please try again.';
                messageDiv.className = 'message error show';
            }
        });

        // Show message
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type} show`;
            setTimeout(() => {
                messageDiv.classList.remove('show');
            }, 5000);
        }

        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = 'login.html';
            }
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Close modal on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('settings-modal');
            if (event.target == modal) {
                closeSettings();
            }
        }

        // Expose a minimal set to window for programmatic use
        window.loadPosts = loadPosts;

        // Attach CSP-safe event listeners for buttons and delegated post actions
        function attachUiListeners() {
            const newBtn = document.getElementById('btn-new-post');
            if (newBtn) newBtn.addEventListener('click', showNewPostForm);

            const refreshBtn = document.getElementById('btn-refresh-posts');
            if (refreshBtn) refreshBtn.addEventListener('click', loadPosts);

            const cancelBtn = document.getElementById('btn-cancel-post');
            if (cancelBtn) cancelBtn.addEventListener('click', hidePostForm);

            const settingsBtn = document.getElementById('btn-settings');
            if (settingsBtn) settingsBtn.addEventListener('click', openSettings);

            const logoutBtn = document.getElementById('btn-logout');
            if (logoutBtn) logoutBtn.addEventListener('click', logout);

            const settingsClose = document.getElementById('settings-close');
            if (settingsClose) settingsClose.addEventListener('click', closeSettings);

            const settingsCancelBtn = document.getElementById('btn-settings-cancel');
            if (settingsCancelBtn) settingsCancelBtn.addEventListener('click', closeSettings);

            // Event delegation for Edit/Delete buttons inside posts container
            const postsContainer = document.getElementById('posts-container');
            if (postsContainer) {
                postsContainer.addEventListener('click', (ev) => {
                    const editBtn = ev.target.closest('.btn-edit');
                    if (editBtn) {
                        const id = editBtn.getAttribute('data-id');
                        if (id) editPost(parseInt(id, 10));
                        return;
                    }

                    const delBtn = ev.target.closest('.btn-delete');
                    if (delBtn) {
                        const id = delBtn.getAttribute('data-id');
                        const title = delBtn.getAttribute('data-title') || '';
                        if (id) deletePost(parseInt(id, 10), title);
                        return;
                    }
                });
            }
        }

        // Initialize
        // Attach handlers before auth check so listeners remain even if checkAuth redirects
        registerFormHandler();
        attachUiListeners();
        checkAuth();
    </script>
</body>
</html>
